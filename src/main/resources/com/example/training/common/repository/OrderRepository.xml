<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper
	namespace="com.example.training.common.repository.OrderRepository">

	<insert id="save" useGeneratedKeys="true" keyProperty="id">
		INSERT
		INTO orders (member_id, phone, name, address, email, price, date)
		VALUES(
		"${memberId}",
		"${phone}",
		"${name}",
		"${address}",
		"${email}",
		${price},
		"${date}")
	</insert>

	<insert id="saveItem">
		INSERT INTO order_items (order_id, name, price,
		quantity, image_path)
		VALUES(
		${id},
		"${item.name}",
		${item.price},
		${item.quantity},
		"${item.imagePath}"
		)
	</insert>

	<select id="findItemsByOrder"
		resultType="com.example.training.common.domain.OrderItem">
		SELECT
		name, price, quantity
		FROM
		order_items
		WHERE order_id =
		${id}

	</select>

	<select id="findById"
		resultType="com.example.training.common.domain.Order">
		SELECT
		*
		FROM
		orders
		WHERE id = ${id}
	</select>

	<select id="findByOrderDate"
		resultType="com.example.training.common.domain.OrderHistory">
		SELECT
		m.id,
		o.id AS "orderId",
		date_format(o.`date`,
		"%Y年%m月") AS orderMonth,
		date_format(o.`date`, "%m月%d日") AS orderDay
		FROM
		ORDERS AS o
		LEFT JOIN
		MEMBERS AS m
		ON m.id = o.member_id
		WHERE m.id =
		${id}
	</select>

	<select id="findItemByOrderHistory"
		resultType="com.example.training.common.domain.OrderHistory">
		SELECT
		m.id AS "memberId",
		o.id AS "orderId",
		oi.name,
		oi.price AS "unitPrice",
		oi.quantity,
		oi.image_path AS "imagePath",
		o.`date`
		FROM
		orders AS o
		LEFT JOIN
		order_items AS oi
		on o.id = oi.order_id
		LEFT
		JOIN
		members AS m
		on m.id =
		o.member_id
		WHERE o.id = ${id}

	</select>
	<select id="findByOrderMonth"
		resultType="com.example.training.common.domain.OrderMonth">
		SELECT
		id AS orderId,
		date_format(o.`date`, '%Y年%m月') AS orderMonth,
		date_format(o.`date`, '%m月%d日') AS orderDay
		FROM orders AS o
		WHERE member_id = ${id}
	</select>

</mapper>
